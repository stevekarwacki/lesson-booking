<template>
  <div class="email-templates-section">
    <div class="section-header">
      <h2>Email Templates</h2>
      <p class="section-description">
        Customize email templates sent to students and instructors. All templates support Handlebars variables for dynamic content.
      </p>
    </div>
    
    <!-- Loading State -->
    <div v-if="loading && !templates.length" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading email templates...</p>
    </div>
    
    <!-- Error State -->
    <div v-if="error" class="error-banner">
      <span class="error-text">{{ error }}</span>
      <button class="error-close" @click="error = ''" aria-label="Close error">&times;</button>
    </div>
    
    <!-- Success State -->
    <div v-if="success" class="success-banner">
      <span class="success-text">{{ success }}</span>
      <button class="success-close" @click="success = ''" aria-label="Close success">&times;</button>
    </div>
    
    <!-- Template List -->
    <div v-if="templates.length > 0" class="templates-container">
      <!-- No active editor: Show template grid -->
      <div v-if="!activeTemplate" class="templates-grid">
        <div 
          v-for="template in templates" 
          :key="template.template_key"
          class="template-card"
          :class="{ modified: isModified(template) }"
        >
          <div class="template-header">
            <h3 class="template-name">{{ template.name }}</h3>
            <div class="template-badges">
              <span v-if="isModified(template)" class="badge modified">Modified</span>
              <span class="badge category">{{ template.category }}</span>
            </div>
          </div>
          
          <p class="template-description">{{ template.description }}</p>
          
          <div class="template-stats">
            <div class="stat-item">
              <span class="stat-label">Variables:</span>
              <span class="stat-value">{{ getVariableCount(template) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Last updated:</span>
              <span class="stat-value">{{ formatDate(template.updated_at) }}</span>
            </div>
          </div>
          
          <div class="template-actions">
            <button 
              @click="editTemplate(template)" 
              class="btn primary"
              :disabled="loading"
            >
              Edit Template
            </button>
            <button 
              @click="testTemplate(template)" 
              class="btn secondary"
              :disabled="loading || testingTemplate === template.template_key"
            >
              <span v-if="testingTemplate === template.template_key" class="loading-spinner small"></span>
              {{ testingTemplate === template.template_key ? 'Sending...' : 'Test Send' }}
            </button>
            <button 
              v-if="isModified(template)"
              @click="resetTemplate(template)" 
              class="btn warning"
              :disabled="loading"
            >
              Reset
            </button>
          </div>
        </div>
      </div>
      
      <!-- Active editor: Show template editor -->
      <div v-else class="template-editor">
        <div class="editor-header">
          <h3>
            <button @click="closeEditor" class="back-button" aria-label="Back to list">
              ← Back
            </button>
            Editing: {{ activeTemplate.name }}
          </h3>
          <div class="editor-actions">
            <button 
              @click="testTemplate(activeTemplate)" 
              class="btn secondary"
              :disabled="loading || testingTemplate === activeTemplate.template_key"
            >
              <span v-if="testingTemplate === activeTemplate.template_key" class="loading-spinner small"></span>
              {{ testingTemplate === activeTemplate.template_key ? 'Sending...' : 'Test Send' }}
            </button>
            <button 
              @click="saveTemplate" 
              class="btn primary"
              :disabled="loading || !hasUnsavedChanges"
            >
              <span v-if="saving" class="loading-spinner small"></span>
              {{ saving ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        </div>
        
        <div class="editor-content">
          <div class="editor-main">
            <!-- Subject Line Editor -->
            <div class="form-group">
              <label for="subject-editor" class="form-label">
                Subject Line
                <button 
                  @click="showVariables = !showVariables" 
                  class="variables-toggle"
                  type="button"
                  aria-label="Toggle variables list"
                >
                  {{ showVariables ? '▼' : '▶' }} Variables
                </button>
              </label>
              <textarea
                id="subject-editor"
                v-model="editingSubject"
                class="form-textarea subject-editor"
                placeholder="Email subject line (supports {{variable}} syntax)"
                rows="2"
                :disabled="loading"
              ></textarea>
            </div>
            
            <!-- Body Content Editor -->
            <div class="form-group">
              <label for="body-editor" class="form-label">
                Email Body Content
              </label>
              <textarea
                id="body-editor"
                v-model="editingBody"
                class="form-textarea body-editor"
                placeholder="Email body content (supports {{variable}} syntax and HTML)"
                rows="20"
                :disabled="loading"
              ></textarea>
            </div>
          </div>
          
          <!-- Variables Sidebar -->
          <div v-if="showVariables" class="variables-sidebar">
            <h4>Available Variables</h4>
            <div class="variables-content">
              <div 
                v-for="(categoryVars, category) in getTemplateVariables(activeTemplate)" 
                :key="category"
                class="variable-category"
              >
                <h5 class="category-name">{{ category }}</h5>
                <div class="variable-list">
                  <button
                    v-for="variable in categoryVars"
                    :key="variable.name"
                    @click="insertVariable(variable.name)"
                    class="variable-item"
                    type="button"
                  >
                    <span class="variable-name">{{ variable.name }}</span>
                    <span class="variable-description">{{ variable.description }}</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed, onMounted, watch } from 'vue'
import { useUserStore } from '../../stores/userStore'

export default {
  name: 'EmailTemplatesSection',
  props: {
    initialData: {
      type: Object,
      default: () => ({})
    },
    loading: {
      type: Boolean,
      default: false
    }
  },
  
  emits: ['change'],
  
  setup(props, { emit }) {
    const userStore = useUserStore()
    
    // State
    const templates = ref([])
    const activeTemplate = ref(null)
    const editingSubject = ref('')
    const editingBody = ref('')
    const originalSubject = ref('')
    const originalBody = ref('')
    const showVariables = ref(false)
    const error = ref('')
    const success = ref('')
    const loading = ref(false)
    const saving = ref(false)
    const testingTemplate = ref(null)
    
    // Computed
    const hasUnsavedChanges = computed(() => {
      if (!activeTemplate.value) return false
      return editingSubject.value !== originalSubject.value || 
             editingBody.value !== originalBody.value
    })
    
    // Methods
    const loadTemplates = async () => {
      try {
        loading.value = true
        error.value = ''
        
        const response = await fetch('/api/admin/email-templates', {
          headers: {
            'Authorization': `Bearer ${userStore.token}`,
            'Content-Type': 'application/json'
          }
        })
        
        if (!response.ok) {
          const errorText = await response.text()
          throw new Error(`Failed to load email templates: ${response.status} ${errorText}`)
        }
        
        const data = await response.json()
        // Check if data is an array directly or has templates property
        templates.value = Array.isArray(data) ? data : (data.templates || [])
        
      } catch (err) {
        error.value = err.message
      } finally {
        loading.value = false
      }
    }
    
    const editTemplate = (template) => {
      activeTemplate.value = template
      editingSubject.value = template.subject_template || ''
      editingBody.value = template.body_template || ''
      originalSubject.value = template.subject_template || ''
      originalBody.value = template.body_template || ''
      showVariables.value = false
    }
    
    const closeEditor = () => {
      if (hasUnsavedChanges.value) {
        if (!confirm('You have unsaved changes. Are you sure you want to close the editor?')) {
          return
        }
      }
      activeTemplate.value = null
      editingSubject.value = ''
      editingBody.value = ''
      originalSubject.value = ''
      originalBody.value = ''
      showVariables.value = false
    }
    
    const saveTemplate = async () => {
      if (!activeTemplate.value) return
      
      try {
        saving.value = true
        error.value = ''
        
        const response = await fetch(`/api/admin/email-templates/${activeTemplate.value.template_key}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${userStore.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: editingSubject.value,
            body_template: editingBody.value
          })
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || 'Failed to save template')
        }
        
        const result = await response.json()
        
        // Update the template in our list
        const templateIndex = templates.value.findIndex(t => t.template_key === activeTemplate.value.template_key)
        if (templateIndex !== -1) {
          templates.value[templateIndex] = result.template
        }
        
        // Update the active template and reset original values
        activeTemplate.value = result.template
        originalSubject.value = result.template.subject_template
        originalBody.value = result.template.body_template
        
        success.value = 'Template saved successfully'
        setTimeout(() => { success.value = '' }, 3000)
        
      } catch (err) {
        error.value = err.message
      } finally {
        saving.value = false
      }
    }
    
    const testTemplate = async (template) => {
      try {
        testingTemplate.value = template.template_key
        error.value = ''
        
        const response = await fetch(`/api/admin/email-templates/${template.template_key}/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${userStore.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientEmail: userStore.user.email
          })
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || 'Failed to send test email')
        }
        
        success.value = `Test email sent to ${userStore.user.email}`
        setTimeout(() => { success.value = '' }, 3000)
        
      } catch (err) {
        error.value = err.message
      } finally {
        testingTemplate.value = null
      }
    }
    
    const resetTemplate = async (template) => {
      if (!confirm(`Are you sure you want to reset "${template.name}" to the default template? This will lose all custom changes.`)) {
        return
      }
      
      try {
        loading.value = true
        error.value = ''
        
        const response = await fetch(`/api/admin/email-templates/${template.template_key}/reset`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${userStore.token}`,
            'Content-Type': 'application/json'
          }
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || 'Failed to reset template')
        }
        
        const result = await response.json()
        
        // Update the template in our list
        const templateIndex = templates.value.findIndex(t => t.template_key === template.template_key)
        if (templateIndex !== -1) {
          templates.value[templateIndex] = result.template
        }
        
        // If this template is currently being edited, update the editor
        if (activeTemplate.value && activeTemplate.value.template_key === template.template_key) {
          editTemplate(result.template)
        }
        
        success.value = 'Template reset to default successfully'
        setTimeout(() => { success.value = '' }, 3000)
        
      } catch (err) {
        error.value = err.message
      } finally {
        loading.value = false
      }
    }
    
    const insertVariable = (variableName) => {
      const textarea = document.getElementById('body-editor')
      if (textarea) {
        const start = textarea.selectionStart
        const end = textarea.selectionEnd
        const text = textarea.value
        const before = text.substring(0, start)
        const after = text.substring(end, text.length)
        const variableText = `{{${variableName}}}`
        
        editingBody.value = before + variableText + after
        
        // Set cursor position after the inserted variable
        setTimeout(() => {
          textarea.focus()
          textarea.setSelectionRange(start + variableText.length, start + variableText.length)
        }, 0)
      }
    }
    
    // Helper functions
    const isModified = (template) => {
      return template.is_modified || false
    }
    
    const getVariableCount = (template) => {
      try {
        const variables = typeof template.available_variables === 'string' 
          ? JSON.parse(template.available_variables) 
          : template.available_variables || {}
        return Object.values(variables).reduce((count, categoryVars) => count + categoryVars.length, 0)
      } catch (e) {
        return 0
      }
    }
    
    const getTemplateVariables = (template) => {
      try {
        return typeof template.available_variables === 'string' 
          ? JSON.parse(template.available_variables) 
          : template.available_variables || {}
      } catch (e) {
        return {}
      }
    }
    
    const formatDate = (dateString) => {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    }
    
    // Lifecycle
    onMounted(() => {
      loadTemplates()
    })
    
    return {
      templates,
      activeTemplate,
      editingSubject,
      editingBody,
      showVariables,
      error,
      success,
      loading,
      saving,
      testingTemplate,
      hasUnsavedChanges,
      loadTemplates,
      editTemplate,
      closeEditor,
      saveTemplate,
      testTemplate,
      resetTemplate,
      insertVariable,
      isModified,
      getVariableCount,
      getTemplateVariables,
      formatDate
    }
  }
}
</script>

<style scoped>
.email-templates-section {
  max-width: 100%;
  padding: var(--spacing-lg);
}

.section-header {
  margin-bottom: var(--spacing-xl);
  text-align: center;
}

.section-header h2 {
  color: var(--text-primary);
  font-size: var(--font-size-2xl);
  margin: 0 0 var(--spacing-sm) 0;
  font-weight: 600;
}

.section-description {
  color: var(--text-secondary);
  font-size: var(--font-size-base);
  line-height: 1.6;
  margin: 0;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

/* Loading State */
.loading-container {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--text-secondary);
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto var(--spacing-md);
}

.loading-spinner.small {
  width: 16px;
  height: 16px;
  border-width: 2px;
  margin: 0;
}

/* Messages */
.error-banner, .success-banner {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  border-radius: var(--border-radius);
  margin-bottom: var(--spacing-lg);
  font-weight: 500;
}

.error-banner {
  background: #fef2f2;
  color: #dc2626;
  border: 1px solid #fecaca;
}

.success-banner {
  background: #f0fdf4;
  color: #16a34a;
  border: 1px solid #bbf7d0;
}

.error-text, .success-text {
  flex: 1;
}

.error-close, .success-close {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0;
  color: inherit;
  opacity: 0.7;
}

.error-close:hover, .success-close:hover {
  opacity: 1;
}

/* Templates Grid */
.templates-container {
  max-width: 100%;
}

.templates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.template-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-lg);
  box-shadow: var(--card-shadow);
  transition: all var(--transition-normal);
}

.template-card.modified {
  border-left: 4px solid var(--warning-color);
}

.template-card:hover {
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.template-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-md);
  gap: var(--spacing-sm);
}

.template-name {
  color: var(--text-primary);
  font-size: var(--font-size-lg);
  font-weight: 600;
  margin: 0;
  flex: 1;
}

.template-badges {
  display: flex;
  gap: var(--spacing-xs);
  flex-wrap: wrap;
}

.badge {
  padding: 0.25rem 0.5rem;
  border-radius: var(--border-radius-sm);
  font-size: var(--font-size-xs);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge.modified {
  background: #fef3c7;
  color: #92400e;
}

.badge.category {
  background: var(--background-hover);
  color: var(--text-secondary);
}

.template-description {
  color: var(--text-secondary);
  margin: 0 0 var(--spacing-md) 0;
  line-height: 1.5;
}

.template-stats {
  display: flex;
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
  font-size: var(--font-size-sm);
}

.stat-item {
  display: flex;
  gap: var(--spacing-xs);
}

.stat-label {
  color: var(--text-secondary);
  font-weight: 500;
}

.stat-value {
  color: var(--text-primary);
}

.template-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

/* Template Editor */
.template-editor {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-lg);
  overflow: hidden;
}

.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-lg);
  background: var(--background-light);
  border-bottom: 1px solid var(--border-color);
  gap: var(--spacing-md);
}

.editor-header h3 {
  color: var(--text-primary);
  font-size: var(--font-size-lg);
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  flex: 1;
}

.back-button {
  background: none;
  border: none;
  color: var(--primary-color);
  cursor: pointer;
  font-size: var(--font-size-base);
  padding: var(--spacing-xs);
  border-radius: var(--border-radius-sm);
  transition: background var(--transition-normal);
}

.back-button:hover {
  background: var(--background-hover);
}

.editor-actions {
  display: flex;
  gap: var(--spacing-sm);
}

.editor-content {
  display: flex;
  min-height: 600px;
}

.editor-main {
  flex: 1;
  padding: var(--spacing-lg);
  overflow-y: auto;
}

.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 500;
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  margin-bottom: var(--spacing-xs);
}

.variables-toggle {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: var(--border-radius-sm);
  font-size: var(--font-size-xs);
  transition: all var(--transition-normal);
}

.variables-toggle:hover {
  background: var(--background-hover);
  color: var(--text-primary);
}

.form-textarea {
  width: 100%;
  padding: var(--spacing-sm);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: var(--font-size-base);
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  transition: border-color var(--transition-normal);
  resize: vertical;
  background: white;
}

.form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.form-textarea:disabled {
  background: var(--background-hover);
  opacity: 0.6;
}

.subject-editor {
  min-height: 60px;
  font-family: var(--font-family);
}

.body-editor {
  min-height: 400px;
  line-height: 1.4;
}

/* Variables Sidebar */
.variables-sidebar {
  width: 300px;
  background: var(--background-light);
  border-left: 1px solid var(--border-color);
  padding: var(--spacing-lg);
  overflow-y: auto;
  flex-shrink: 0;
}

.variables-sidebar h4 {
  color: var(--text-primary);
  font-size: var(--font-size-base);
  font-weight: 600;
  margin: 0 0 var(--spacing-md) 0;
}

.variables-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.variable-category {
  border-bottom: 1px solid var(--border-color);
  padding-bottom: var(--spacing-md);
}

.variable-category:last-child {
  border-bottom: none;
}

.category-name {
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  font-weight: 500;
  margin: 0 0 var(--spacing-sm) 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.variable-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.variable-item {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: var(--spacing-xs) var(--spacing-sm);
  cursor: pointer;
  text-align: left;
  transition: all var(--transition-normal);
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.variable-item:hover {
  border-color: var(--primary-color);
  background: var(--primary-light, #f8f9fa);
}

.variable-name {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: var(--font-size-xs);
  color: var(--primary-color);
  font-weight: 600;
}

.variable-description {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  line-height: 1.3;
}

/* Buttons */
.btn {
  padding: var(--spacing-sm) var(--spacing-md);
  border: none;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  font-weight: 500;
  transition: all var(--transition-normal);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: var(--font-size-sm);
  text-decoration: none;
  font-family: var(--font-family);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn.primary {
  background: var(--primary-color);
  color: white;
}

.btn.primary:hover:not(:disabled) {
  background: var(--primary-dark, #218838);
}

.btn.secondary {
  background: var(--background-hover);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn.secondary:hover:not(:disabled) {
  background: var(--border-color);
}

.btn.warning {
  background: var(--warning-color, #ffc107);
  color: var(--text-primary);
}

.btn.warning:hover:not(:disabled) {
  background: #e0a800;
}

/* Animations */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 1024px) {
  .editor-content {
    flex-direction: column;
  }
  
  .variables-sidebar {
    width: 100%;
    border-left: none;
    border-top: 1px solid var(--border-color);
    max-height: 300px;
  }
  
  .editor-header {
    flex-direction: column;
    gap: var(--spacing-sm);
    align-items: stretch;
  }
  
  .editor-actions {
    justify-content: flex-end;
  }
}

@media (max-width: 768px) {
  .email-templates-section {
    padding: var(--spacing-md);
  }
  
  .templates-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
  
  .template-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-xs);
  }
  
  .template-stats {
    flex-direction: column;
    gap: var(--spacing-xs);
  }
  
  .template-actions {
    flex-direction: column;
  }
  
  .editor-header h3 {
    font-size: var(--font-size-base);
  }
  
  .editor-actions {
    flex-direction: column;
  }
  
  .variables-sidebar {
    padding: var(--spacing-md);
  }
}

@media (max-width: 480px) {
  .editor-main {
    padding: var(--spacing-md);
  }
  
  .body-editor {
    min-height: 300px;
  }
  
  .btn {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-xs);
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  .loading-spinner {
    animation: none;
  }
  
  .template-card {
    transition: none;
  }
  
  .btn {
    transition: none;
  }
}
</style>